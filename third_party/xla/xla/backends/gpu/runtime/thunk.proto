/* Copyright 2025 The OpenXLA Authors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
==============================================================================*/

syntax = "proto3";

package xla.gpu;

import "xla/backends/gpu/runtime/buffer_debug_log.proto";
import "xla/backends/gpu/runtime/collective_thunk.proto";
import "xla/backends/gpu/runtime/convolution_filter_thunk.proto";
import "xla/backends/gpu/runtime/convolution_reorder_thunk.proto";
import "xla/backends/gpu/runtime/convolution_thunk.proto";
import "xla/backends/gpu/runtime/copy_thunk.proto";
import "xla/backends/gpu/runtime/cub_sort_thunk.proto";
import "xla/backends/gpu/runtime/cublas_lt_matmul_thunk.proto";
import "xla/backends/gpu/runtime/cudnn_thunk.proto";
import "xla/backends/gpu/runtime/custom_call_thunk.proto";
import "xla/backends/gpu/runtime/custom_kernel_thunk.proto";
import "xla/backends/gpu/runtime/dynamic_slice_thunk.proto";
import "xla/backends/gpu/runtime/fft_thunk.proto";
import "xla/backends/gpu/runtime/gemm_thunk.proto";
import "xla/backends/gpu/runtime/host_execute_thunk.proto";
import "xla/backends/gpu/runtime/host_send_recv_thunk.proto";
import "xla/backends/gpu/runtime/infeed_thunk.proto";
import "xla/backends/gpu/runtime/kernel_thunk.proto";
import "xla/backends/gpu/runtime/memset_thunk.proto";
import "xla/backends/gpu/runtime/norm_thunk.proto";
import "xla/backends/gpu/runtime/outfeed_thunk.proto";
import "xla/backends/gpu/runtime/replica_id_thunk.proto";
import "xla/backends/gpu/runtime/select_k_thunk.proto";
import "xla/backends/gpu/runtime/shaped_slice.proto";
import "xla/backends/gpu/runtime/thunk_kind.proto";
import "xla/backends/gpu/runtime/triangular_solve_thunk.proto";
import "xla/backends/gpu/runtime/wait_for_streams_thunk.proto";
import "xla/core/host_offloading/host_offloading_executable.proto";
import "xla/ffi/attribute_map.proto";
import "xla/ffi/execution_state.proto";
import "xla/service/buffer_assignment.proto";
import "xla/service/gpu/gpu_conv_runner.proto";
import "xla/service/gpu/gpu_norm_runner.proto";
import "xla/service/gpu/kernels/custom_kernel.proto";
import "xla/service/gpu/launch_dimensions.proto";
import "xla/service/hlo.proto";
import "xla/stream_executor/gpu/gpu_blas_lt.proto";
import "xla/stream_executor/gpu/tma_metadata.proto";
import "xla/stream_executor/launch_dim.proto";
import "xla/xla_data.proto";

option java_multiple_files = true;
option java_outer_classname = "ThunkProtoOuterClass";

// Contains basic pieces of information that every thunk type has.
message ThunkInfoProto {
  string profile_annotation = 1;
  int64 execution_stream_id = 2;
  int64 thunk_id = 3;
}

// A lightweight version of ThunkProto which only stores the thunk kind and
// the thunk info.
message ThunkMetadataProto {
  ThunkInfoProto thunk_info = 1;
  string thunk_kind = 2;
}

// The metadata of a list of thunks - usually an entire thunk graph.
message ThunkMetadataListProto {
  repeated ThunkMetadataProto thunk_metadata = 1;
}

message ConditionalThunkProto {
  ShapedSliceProto branch_index_buffer = 1;
  repeated SequentialThunkProto branch_thunks = 2;
}

message WhileThunkProto {
  xla.buffer_assignment.BufferAllocationSliceProto
      condition_result_buffer_index = 1;
  SequentialThunkProto condition_thunk_sequence = 2;
  SequentialThunkProto body_thunk_sequence = 3;
  optional int64 trip_count = 4;
}

message DynamicSliceThunkProto {
  SequentialThunkProto embedded_thunk = 1;
  repeated OptionalBufferAllocationSliceProto arguments = 2;
  repeated OptionalDynamicSliceOffsetsProto offsets = 3;
  repeated OptionalShapeProto orig_shapes = 4;
  repeated OptionalShapeProto sliced_shapes = 5;
  repeated OptionalPrimitiveType offset_primitive_types = 6;
  optional OffsetAsFunctionOfIndvarModulesMetadataProto
      offset_as_function_of_indvar_modules_metadata = 7;
  repeated BufferAllocationProto fake_allocations = 8;
}

message CollectiveGroupThunkProto {
  ThunkKindProto thunk_kind = 1;
  repeated ThunkProto thunks = 2;
  AsyncStreamKind async_stream_kind = 3;
  optional uint64 async_events_unique_id = 4;
}

message ThunkProto {
  ThunkInfoProto thunk_info = 1;

  oneof impl {
    SequentialThunkProto sequential_thunk = 2;
    CopyThunkProto copy_thunk = 3;
    DeviceToHostCopyThunkProto device_to_host_copy_thunk = 4;
    HostToDeviceCopyThunkProto host_to_device_copy_thunk = 5;
    ConditionalThunkProto conditional_thunk = 6;
    WhileThunkProto while_thunk = 7;
    KernelThunkProto kernel_thunk = 8;
    GemmThunkProto gemm_thunk = 9;
    WaitForStreamsThunkProto wait_for_streams_thunk = 10;
    TriangularSolveThunkProto triangular_solve_thunk = 11;
    ReplicaIdThunkProto replica_id_thunk = 12;
    DeviceToDeviceCopyThunkProto device_to_device_copy_thunk = 13;
    PartitionIdThunkProto partition_id_thunk = 14;
    CudnnThunkProto cudnn_thunk = 15;
    HostExecuteStartThunkProto host_execute_start_thunk = 16;
    HostExecuteDoneThunkProto host_execute_done_thunk = 17;
    DynamicSliceThunkProto dynamic_slice_thunk = 18;
    MemzeroThunkProto memzero_thunk = 19;
    SelectKThunkProto select_k_thunk = 20;
    InfeedThunkProto infeed_thunk = 21;
    CublasLtMatmulThunkProto cublas_lt_matmul_thunk = 22;
    OutfeedThunkProto outfeed_thunk = 23;
    NormThunkProto norm_thunk = 24;
    ConvolutionThunkProto convolution_thunk = 25;
    ConvolutionReorderThunkProto convolution_reorder_thunk = 26;
    FftThunkProto fft_thunk = 27;
    Memset32BitValueThunkProto memset32bit_value_thunk = 28;
    CustomCallThunkProto custom_call_thunk = 30;
    CubSortThunkProto cub_sort_thunk = 31;
    HostSendThunkProto host_send_thunk = 32;
    HostSendDoneThunkProto host_send_done_thunk = 33;
    HostRecvThunkProto host_recv_thunk = 34;
    HostRecvDoneThunkProto host_recv_done_thunk = 35;
    CustomKernelThunkProto custom_kernel_thunk = 36;
    CollectiveDoneThunkProto collective_done_thunk = 37;
    AllGatherStartThunkProto all_gather_start_thunk = 38;
    AllReduceStartThunkProto all_reduce_start_thunk = 39;
    AllToAllStartThunkProto all_to_all_start_thunk = 40;
    RaggedAllToAllStartThunkProto ragged_all_to_all_start_thunk = 41;
    CollectivePermuteStartThunkProto collective_permute_start_thunk = 42;
    SendThunkProto send_thunk = 43;
    RecvThunkProto recv_thunk = 44;
    CollectiveBroadcastStartThunkProto collective_broadcast_start_thunk = 45;
    CollectiveGroupThunkProto collective_group_thunk = 46;
    DynamicMemcpyThunkProto dynamic_memcpy_thunk = 47;
  }
}

message SequentialThunkProto {
  repeated ThunkProto thunks = 1;
}
