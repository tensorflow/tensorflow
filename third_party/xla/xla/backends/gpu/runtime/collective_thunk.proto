/* Copyright 2025 The OpenXLA Authors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
==============================================================================*/

syntax = "proto3";

package xla.gpu;

import "xla/backends/gpu/runtime/thunk_kind.proto";
import "xla/service/buffer_assignment.proto";
import "xla/service/hlo.proto";
import "xla/xla_data.proto";

option java_multiple_files = true;
option java_outer_classname = "CollectiveThunkProtoOuterClass";

message CollectiveBufferProto {
  int64 element_count = 1;
  xla.buffer_assignment.BufferAllocationSliceProto source_buffer = 2;
  xla.buffer_assignment.BufferAllocationSliceProto destination_buffer = 3;
  int64 source_memory_space = 4;
  int64 destination_memory_space = 5;
}

message CollectiveConfigProto {
  repeated PrimitiveType operand_element_type = 1;
  repeated ReplicaGroup replica_groups = 2;
  CollectiveOpGroupMode group_mode = 3;
  bool use_symmetric_buffer = 4;
}

message CollectiveThunkProto {
  ThunkKindProto thunk_kind = 1;
  AsyncStreamKind async_stream_kind = 2;
  uint64 async_events_unique_id = 3;
}

message AllGatherStartThunkProto {
  optional uint64 async_events_unique_id = 1;
  CollectiveConfigProto collective_config = 2;
  repeated CollectiveBufferProto buffers = 3;
}

enum ReductionKindProto {
  REDUCTION_KIND_UNSPECIFIED = 0;
  REDUCTION_KIND_SUM = 1;
  REDUCTION_KIND_PRODUCT = 2;
  REDUCTION_KIND_MIN = 3;
  REDUCTION_KIND_MAX = 4;
}

message AllReduceStartThunkProto {
  optional uint64 async_events_unique_id = 1;
  CollectiveConfigProto collective_config = 2;
  repeated CollectiveBufferProto buffers = 3;

  ReductionKindProto reduction_kind = 4;
  bool is_multimem_enabled = 5;
  int32 shmem_bytes = 6;
  string kernel_name = 7;
  bool collective_kernel_enabled = 8;
  bool is_async = 9;
}

message AllToAllStartThunkProto {
  optional uint64 async_events_unique_id = 1;
  CollectiveConfigProto collective_config = 2;
  repeated CollectiveBufferProto buffers = 3;

  bool has_split_dimension = 4;
  bool p2p_memcpy_enabled = 5;
}

message RaggedAllToAllStartThunkProto {
  optional uint64 async_events_unique_id = 1;
  CollectiveConfigProto collective_config = 2;
  repeated CollectiveBufferProto buffers = 3;

  int64 num_total_updates = 4;
  int64 num_input_rows = 5;
  int64 num_row_elements = 6;
  bool one_shot_kernel_enabled = 7;
}

message CollectivePermuteStartThunkProto {
  optional uint64 async_events_unique_id = 1;
  repeated CollectiveBufferProto buffers = 2;

  CollectiveConfigProto collective_config = 3;
  repeated SourceTarget source_target_pairs = 4;

  AsyncStreamKind async_stream_kind = 5;
  bool p2p_memcpy_enabled = 6;
}

message SendThunkProto {
  uint64 async_events_unique_id = 1;
  CollectiveBufferProto buffer = 2;

  CollectiveConfigProto collective_config = 3;
  repeated SourceTarget source_target_pairs = 4;

  AsyncStreamKind async_stream_kind = 5;
  string instruction_name = 6;
}

message RecvThunkProto {
  uint64 async_events_unique_id = 1;
  CollectiveBufferProto buffer = 2;

  CollectiveConfigProto collective_config = 3;
  repeated SourceTarget source_target_pairs = 4;

  AsyncStreamKind async_stream_kind = 5;
  string instruction_name = 6;
}

message CollectiveBroadcastStartThunkProto {
  optional uint64 async_events_unique_id = 1;
  repeated CollectiveBufferProto buffers = 2;
  CollectiveConfigProto collective_config = 3;
}

message CollectiveDoneThunkProto {
  ThunkKindProto thunk_kind = 1;
  AsyncStreamKind async_stream_kind = 2;
  optional uint64 async_events_unique_id = 3;
}
