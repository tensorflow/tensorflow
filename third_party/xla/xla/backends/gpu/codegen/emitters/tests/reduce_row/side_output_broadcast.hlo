// RUN: gpu_test_correctness %s

%add {
  p0 = f32[] parameter(0)
  p1 = f32[] parameter(1)
  ROOT add = f32[] add(p0, p1)
}

// Use 8x8 (64 elements) to ensure the reduction is routed to the Reduction
// emitter on both CUDA (warp_size=32) and ROCm (warp_size=64). The heuristic
// IsUnnestedReductionFasterThanElemental requires dims >= warp_size.
fusion {
  %p0 = f32[8,8] parameter(0)
  %c0 = f32[] constant(0)
  %reduce = f32[] reduce(%p0, %c0), dimensions={0,1}, to_apply=%add
  %broadcast = f32[8,8] broadcast(%reduce), dimensions={}
  ROOT %tuple = (f32[8,8], f32[]) tuple(%broadcast, %reduce)
}