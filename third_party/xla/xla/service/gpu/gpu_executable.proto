syntax = "proto3";

package xla.gpu;

import "xla/backends/gpu/runtime/thunk.proto";
import "xla/service/gpu/ir_emission_utils.proto";
import "xla/service/hlo.proto";
import "xla/shape_util.proto";
import "xla/stream_executor/device_description.proto";
import "xla/xla.proto";
import "xla/xla_data.proto";

// Serialized representation of a GPU executable, used for AOT compilation.
//
// There's a legacy and a new verions of this proto, see
// `xla::gpu::LegacyGpuAotCompilationResult` and
// `xla::gpu::GpuAotCompilationResult` respectively for more details.
//
// If `thunk` is set, then this is the new format. Otherwise, it's the legacy
// format.
message GpuExecutableProto {
  // The HLO module of the executable - for debugging purposes only.
  xla.HloModuleProtoWithConfig hlo_module_with_config = 1;

  // Wrapper around repeated BufferAllocationProto to allow using it in a oneof.
  message RepeatedBufferAllocations {
    repeated BufferAllocationProto values = 1;
  }

  // Used in the legacy format.
  BufferAssignmentProto buffer_assignment = 2;
  // The buffer allocations of the executable, used in the new format.
  RepeatedBufferAllocations buffer_allocations = 10;

  // The PTX of the executable. (Only applicable to CUDA)
  string asm_text = 3;

  // The binary of the executable.
  //
  // For CUDA, this is a cubin binary.
  // For ROCm, this is a hsaco binary.
  bytes binary = 4;

  // The DNN compiled graphs of the executable.
  //
  // The key is the DNN kernel name, and the value is the compiled graph
  // serialized to JSON. (Only applicable to cuDNN)
  map<string, bytes> dnn_compiled_graphs = 5;

  // The target compute capability of the executable.
  stream_executor.GpuComputeCapabilityProto gpu_compute_capability = 6;

  // The thunk tree of the executable.
  // Not set in the legacy format.
  optional ThunkProto thunk = 7;

  // The name of the HLO module - for debugging purposes only.
  string module_name = 8;

  // The shape of the program (parameters and result).
  xla.ProgramShapeProto program_shape = 9;

  message OutputInfoProto {
    // This output is part of the following buffer allocation
    int64 allocation_index = 1;

    // True when this output is passed through from an input parameter
    bool passthrough = 2;

    // Describes whether and how this output aliases with an input parameter
    optional xla.HloInputOutputAliasProto.AliasEntryProto alias_config = 3;
  }

  message OutputInfoMapEntry {
    xla.ShapeIndexProto shape_index = 1;
    OutputInfoProto output_info = 2;
  }

  // Map from output shape index to output info.
  repeated OutputInfoMapEntry output_info_map = 11;

  message ConstantInfoProto {
    // The name of the constant in the HLO module.
    string symbol_name = 1;

    // The content of the constant - this can be large.
    DenseDataIntermediateProto content = 2;

    // The index of the buffer allocation for this constant.
    int64 allocation_index = 3;
  }

  // The constants used by the executable.
  repeated ConstantInfoProto constants = 12;
}
