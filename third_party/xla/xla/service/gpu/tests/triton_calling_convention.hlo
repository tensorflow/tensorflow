// RUN: hlo-opt %s --platform=gpu --stage=llvm-before-optimizations --xla_gpu_target_config_filename=%S/../../../backends/gpu/target_config/specs/%{GPU}.txtpb | FileCheck --check-prefixes=CHECK-%{PTX} %s

// Verify that Triton kernels have the correct calling convention:
// - PTX_KERNEL (71) for NVIDIA targets
// - AMDGPU_KERNEL (91) for AMD targets
// CHECK-PTX: define ptx_kernel void @triton_
// CHECK-GCN: define amdgpu_kernel void @triton_

HloModule TritonCallingConvention, is_scheduled=true

triton_softmax {
  param_0 = f32[4,4]{1,0} parameter(0)
  ROOT exp = f32[4,4]{1,0} exponential(param_0)
}

ENTRY main {
  param_0 = f32[4,4]{1,0} parameter(0)
  ROOT triton_softmax = f32[4,4]{1,0} fusion(param_0), kind=kCustom,
    calls=triton_softmax,
    backend_config={"fusion_backend_config":{
      "kind":"__triton",
      "block_level_fusion_config":{"output_tiles":[{"sizes":["4","4"]}],
                                   "num_warps":"1",
                                   "num_ctas":"1",
                                   "num_stages":"1"}}}
}
