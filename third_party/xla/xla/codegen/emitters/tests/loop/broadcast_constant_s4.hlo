// RUN: gpu_fusion_to_mlir %s | emitters_opt --xla-test-optimize \
// RUN:   --inline="default-pipeline='cse'" | FileCheck %s --check-prefixes=CHECK,CHECK-GPU
// RUN: cpu_fusion_to_mlir %s | emitters_opt --xla-test-optimize \
// RUN:   --inline="default-pipeline='cse'" | FileCheck %s
// RUN: gpu_test_correctness %s --bijection_outputs=broadcast
// RUN: cpu_test_correctness %s

bcast {
  x = s4[] constant(-2)
  ROOT broadcast = s4[3]{0} broadcast(x), dimensions={}
}
// CHECK: func.func @main(%[[ARG0:.*]]: tensor<3xi4>
// CHECK-GPU: scf.forall {{.*}} shared_outs(%[[FORALL_ARG0:.*]] = %[[ARG0]])
// CHECK:   xla.loop ({{.*}})[{{.*}}] -> (%[[RA:.*]]) in
// CHECK-SAME: iter_args(%[[ITER:.*]] =
// CHECK-GPU-SAME: %[[FORALL_ARG0]])
// CHECK-CPU-SAME: %[[ARG0]])
// CHECK:     %[[CST:.*]] = arith.constant -2
// CHECK:     %[[INSERTED:.*]] = tensor.insert %[[CST]] into %[[ITER]][%[[RA]]]
