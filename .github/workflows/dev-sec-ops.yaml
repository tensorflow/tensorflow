name: TensorFlow SAST CI Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  sast-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run Cppcheck C++ Analysis
        run: |
          cppcheck --enable=warning,style,performance,portability,information \
            --suppress=missingIncludeSystem \
            --xml --xml-version=2 \
            --output-file=cppcheck-report.xml \
            tensorflow/core/ tensorflow/python/ tensorflow/cc/ \
            2>&1 || true
        continue-on-error: true

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit Python Security Scan
        run: |
          bandit -r tensorflow/ -ll -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Upload SAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-reports
          path: |
            cppcheck-report.xml
            bandit-report.json

      - name: Display Cppcheck Summary
        if: always()
        run: |
          echo "=== Cppcheck Summary ==="
          if [ -f cppcheck-report.xml ]; then
            grep -o 'severity="[^"]*"' cppcheck-report.xml | sort | uniq -c || echo "No issues found"
          else
            echo "Cppcheck report not found"
          fi

      - name: Display Bandit Summary
        if: always()
        run: |
          echo "=== Bandit Summary ==="
          if [ -f bandit-report.json ]; then
            python3 -c "import json; data=json.load(open('bandit-report.json')); print(f\"High: {len([i for i in data['results'] if i['issue_severity']=='HIGH'])}\\nMedium: {len([i for i in data['results'] if i['issue_severity']=='MEDIUM'])}\\nLow: {len([i for i in data['results'] if i['issue_severity']=='LOW'])}\")" || echo "No issues or error parsing"
          else
            echo "Bandit report not found"
          fi
